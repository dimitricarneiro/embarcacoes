<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastrar Pedido de Autoriza√ß√£o</title>
  <style>
    /* Seus estilos permanecem inalterados */
    body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 20px; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1); }
    h1 { text-align: center; color: #333; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; }
    button { width: 100%; padding: 10px; margin-top: 20px; border: none; background-color: #007bff; color: white; font-size: 16px; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    #mensagem { text-align: center; font-weight: bold; margin-top: 20px; }
    .navbar { display: flex; justify-content: space-between; align-items: center; background: #007bff; color: white; padding: 10px 20px; border-radius: 5px; margin-bottom: 20px; }
    .btn-logout { text-decoration: none; background-color: red; color: white; padding: 8px 12px; border-radius: 5px; font-weight: bold; }
    .btn-logout:hover { background-color: darkred; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2); }
    button { margin: 10px; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { opacity: 0.8; }
  </style>
</head>
<body>

<div class="navbar">
  <span>Bem-vindo, {{ current_user.username }} / {{ current_user.nome_empresa }} / {{ current_user.cnpj }}</span>
  <a class="btn-logout" href="{{ url_for('auth.logout') }}">üö™ Sair</a>
</div>

<div class="container">
  <h1>Cadastrar Pedido de Autoriza√ß√£o</h1>
  <form id="pedido-form">
    <!-- Campos do pedido principal -->
    <label>Nome da Empresa:</label>
    <input type="text" id="nome_empresa" value="{{ current_user.nome_empresa }}" required>

    <label>CNPJ:</label>
    <input type="text" id="cnpj_empresa" value="{{ current_user.cnpj }}" required>

    <label>Endere√ßo:</label>
    <input type="text" id="endereco_empresa" value="Rua Teste" required>

    <label>Motivo:</label>
    <input type="text" id="motivo_solicitacao" value="Inspe√ß√£o de casco" required>

    <label>Data In√≠cio:</label>
    <input type="date" id="data_inicio" required>

    <label>Data T√©rmino:</label>
    <input type="date" id="data_termino" required>

	<label>Hor√°rio In√≠cio:</label>
	<input type="text" id="horario_inicio_servicos" value="08:00" required>

	<label>Hor√°rio T√©rmino:</label>
	<input type="text" id="horario_termino_servicos" value="18:00" required>

    <label>N√∫mero do Certificado de Livre Pr√°tica:</label>
    <input type="text" id="num_certificado_livre_pratica" value="12345" required>

    <label>Embarca√ß√µes (separadas por v√≠rgula):</label>
    <input type="text" id="embarcacoes" value="nenhuma">

    <label>Ve√≠culos (para cada ve√≠culo, informe modelo e placa separados por h√≠fen; m√∫ltiplos ve√≠culos separados por v√≠rgula):</label>
    <input type="text" id="veiculos" value="nenhum">

    <label>Equipamentos (para cada equipamento, informe modelo e placa separados por h√≠fen; m√∫ltiplos equipamentos separados por v√≠rgula):</label>
    <input type="text" id="equipamentos" value="nenhum">

    <label>Pessoas (para cada pessoa, informe nome e CPF separados por h√≠fen; m√∫ltiplas pessoas separadas por v√≠rgula):</label>
    <input type="text" id="pessoas" value="nenhuma">

    <button type="button" onclick="enviarPedido()">Enviar Pedido de Autoriza√ß√£o</button>
  </form>

  <p id="mensagem"></p>
</div>

<!-- Modal de Expira√ß√£o de Sess√£o -->
<div id="session-modal" class="modal">
  <div class="modal-content">
    <h2>Aviso de Sess√£o</h2>
    <p>Sua sess√£o est√° prestes a expirar. Deseja continuar logado?</p>
    <button onclick="continuarSessao()">Continuar Logado</button>
    <button onclick="sairSessao()">Sair</button>
  </div>
</div>

<script>
  // Monitoramento de sess√£o (c√≥digo inalterado)
  let tempoExpiracao = 30 * 60 * 1000; // 30 minutos em milissegundos
  let avisoExpiracao = 28 * 60 * 1000; // Exibir modal 2 minutos antes da expira√ß√£o
  let modal = document.getElementById("session-modal");
  let sessionTimeout;
  function iniciarMonitoramentoSessao() {
    setTimeout(() => { modal.style.display = "flex"; }, avisoExpiracao);
    sessionTimeout = setTimeout(() => { window.location.href = "/auth/logout"; }, tempoExpiracao);
  }
  function continuarSessao() {
    modal.style.display = "none";
    clearTimeout(sessionTimeout);
    fetch("/auth/renovar-sessao", { method: "GET" })
      .then(response => console.log("Sess√£o renovada"))
      .catch(error => console.error("Erro ao renovar sess√£o", error));
    iniciarMonitoramentoSessao();
  }
  function sairSessao() { window.location.href = "/auth/logout"; }
  document.addEventListener("DOMContentLoaded", iniciarMonitoramentoSessao);

  // Fun√ß√£o de valida√ß√£o de CNPJ (inalterada)
  function validarCNPJ(cnpj) {
    cnpj = cnpj.replace(/[^\d]+/g, "");
    if (cnpj.length !== 14) return false;
    if (/^(\d)\1+$/.test(cnpj)) return false;
    let tamanho = cnpj.length - 2;
    let numeros = cnpj.substring(0, tamanho);
    let digitos = cnpj.substring(tamanho);
    let soma = 0;
    let pos = tamanho - 7;
    for (let i = tamanho; i >= 1; i--) {
      soma += numeros.charAt(tamanho - i) * pos--;
      if (pos < 2) pos = 9;
    }
    let resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
    if (resultado !== parseInt(digitos.charAt(0))) return false;
    tamanho += 1;
    numeros = cnpj.substring(0, tamanho);
    soma = 0;
    pos = tamanho - 7;
    for (let i = tamanho; i >= 1; i--) {
      soma += numeros.charAt(tamanho - i) * pos--;
      if (pos < 2) pos = 9;
    }
    resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
    if (resultado !== parseInt(digitos.charAt(1))) return false;
    return true;
  }

  // Fun√ß√£o para enviar o pedido
  function enviarPedido() {
    let cnpj = document.getElementById("cnpj_empresa").value;
    if (!validarCNPJ(cnpj)) {
      document.getElementById("mensagem").innerText = "CNPJ inv√°lido!";
      document.getElementById("mensagem").style.color = "red";
      return;
    }

    // Coleta e processamento dos campos, convertendo strings em arrays
    const embarcacoes = document.getElementById("embarcacoes").value
      .split(",").map(item => item.trim()).filter(item => item !== "");
    const veiculos = document.getElementById("veiculos").value
      .split(",").map(item => item.trim()).filter(item => item !== "");
    const equipamentos = document.getElementById("equipamentos").value
      .split(",").map(item => item.trim()).filter(item => item !== "");
    const pessoas = document.getElementById("pessoas").value
      .split(",").map(item => item.trim()).filter(item => item !== "");

    const pedido = {
      nome_empresa: document.getElementById("nome_empresa").value,
      cnpj_empresa: cnpj,
      endereco_empresa: document.getElementById("endereco_empresa").value,
      motivo_solicitacao: document.getElementById("motivo_solicitacao").value,
      data_inicio: document.getElementById("data_inicio").value,
      data_termino: document.getElementById("data_termino").value,
      horario_inicio_servicos: document.getElementById("horario_inicio_servicos").value,
   	  horario_termino_servicos: document.getElementById("horario_termino_servicos").value,
      num_certificado_livre_pratica: document.getElementById("num_certificado_livre_pratica").value,
      observacoes: "Nenhuma",
      embarcacoes: embarcacoes,
      veiculos: veiculos,
      equipamentos: equipamentos,
      pessoas: pessoas
    };

    fetch('/api/pedidos-autorizacao', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(pedido)
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(errorData => {
          throw new Error(errorData.error || 'Erro ao criar pedido.');
        });
      }
      return response.json();
    })
    .then(data => {
      document.getElementById("mensagem").innerText = `Pedido criado com sucesso! ID: ${data.id_autorizacao}`;
      document.getElementById("mensagem").style.color = "green";
    })
    .catch(error => {
      document.getElementById("mensagem").innerText = error.message;
      document.getElementById("mensagem").style.color = "red";
      console.error("Erro:", error);
    });
  }
</script>

</body>
</html>

