<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastrar Pedido de Autoriza√ß√£o</title>
  <style>
    /* Estilos gerais inalterados */
    body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 20px; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1); }
    h1 { text-align: center; color: #333; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; }
    button { width: 100%; padding: 10px; margin-top: 20px; border: none; background-color: #007bff; color: white; font-size: 16px; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    #mensagem { text-align: center; font-weight: bold; margin-top: 20px; }
    .navbar { display: flex; justify-content: space-between; align-items: center; background: #007bff; color: white; padding: 10px 20px; border-radius: 5px; margin-bottom: 20px; }
    .btn-logout { text-decoration: none; background-color: red; color: white; padding: 8px 12px; border-radius: 5px; font-weight: bold; }
    .btn-logout:hover { background-color: darkred; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2); }
    
    /* Estilos para blocos din√¢micos */
    .bloco {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .bloco label {
      margin-top: 0;
    }
    .btn-adicionar {
      width: auto;
      padding: 8px 12px;
      background-color: #28a745;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .btn-adicionar:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>

<div class="navbar">
  <span>Bem-vindo, {{ current_user.username }} / {{ current_user.nome_empresa }} / {{ current_user.cnpj }}</span>
  <a class="btn-logout" href="{{ url_for('auth.logout') }}">üö™ Sair</a>
</div>

<div class="container">
  <h1>Cadastrar Pedido de Autoriza√ß√£o</h1>
  <form id="pedido-form">
    <!-- Campos do pedido principal -->
    <label>Nome da Empresa:</label>
    <input type="text" id="nome_empresa" value="{{ current_user.nome_empresa }}" required>

    <label>CNPJ:</label>
    <input type="text" id="cnpj_empresa" value="{{ current_user.cnpj }}" required>

    <label>Endere√ßo:</label>
    <input type="text" id="endereco_empresa" value="Rua Teste" required>

    <label>Motivo:</label>
    <input type="text" id="motivo_solicitacao" value="Inspe√ß√£o de casco" required>

    <label>Data In√≠cio:</label>
    <input type="date" id="data_inicio" required>

    <label>Data T√©rmino:</label>
    <input type="date" id="data_termino" required>

    <label>Hor√°rio In√≠cio:</label>
    <input type="text" id="horario_inicio_servicos" value="08:00" required>

    <label>Hor√°rio T√©rmino:</label>
    <input type="text" id="horario_termino_servicos" value="18:00" required>

    <label>N√∫mero do Certificado de Livre Pr√°tica:</label>
    <input type="text" id="num_certificado_livre_pratica" value="12345" required>

    <label>Embarca√ß√µes (separadas por v√≠rgula):</label>
    <input type="text" id="embarcacoes" value="nenhuma">

    <!-- Se√ß√£o para Ve√≠culos -->
    <label>Ve√≠culos:</label>
    <div id="veiculos-container">
      <!-- Bloco de ve√≠culo inicial -->
      <div class="bloco">
        <label>Modelo do Ve√≠culo:</label>
        <input type="text" class="veiculo-modelo" placeholder="Modelo do ve√≠culo" required>
        <label>Placa do Ve√≠culo:</label>
        <input type="text" class="veiculo-placa" placeholder="Placa do ve√≠culo" required>
      </div>
    </div>
    <button type="button" class="btn-adicionar" onclick="adicionarVeiculo()">Adicionar mais ve√≠culos</button>

    <!-- Se√ß√£o para Equipamentos -->
    <label>Equipamentos:</label>
    <div id="equipamentos-container">
      <!-- Bloco de equipamento inicial -->
      <div class="bloco">
        <label>Descri√ß√£o do Equipamento:</label>
        <input type="text" class="equipamento-descricao" placeholder="Descri√ß√£o do equipamento" required>
        <label>N√∫mero de S√©rie:</label>
        <input type="text" class="equipamento-numero-serie" placeholder="N√∫mero de s√©rie do equipamento" required>
        <label>Quantidade:</label>
        <input type="number" class="equipamento-quantidade" placeholder="Quantidade" min="1" required>
      </div>
    </div>
    <button type="button" class="btn-adicionar" onclick="adicionarEquipamento()">Adicionar mais equipamentos</button>

    <!-- Se√ß√£o para Pessoas (j√° implementada anteriormente) -->
    <label>Pessoas:</label>
    <div id="pessoas-container">
      <div class="bloco">
        <label>Nome da Pessoa:</label>
        <input type="text" class="pessoa-nome" placeholder="Nome da pessoa" required>
        <label>CPF:</label>
        <input type="text" class="pessoa-cpf" placeholder="CPF da pessoa" required>
      </div>
    </div>
    <button type="button" class="btn-adicionar" onclick="adicionarPessoa()">Adicionar mais pessoas</button>

    <button type="button" onclick="enviarPedido()">Enviar Pedido de Autoriza√ß√£o</button>
  </form>

  <p id="mensagem"></p>
</div>

<!-- Modal de Expira√ß√£o de Sess√£o (inalterado) -->
<div id="session-modal" class="modal">
  <div class="modal-content">
    <h2>Aviso de Sess√£o</h2>
    <p>Sua sess√£o est√° prestes a expirar. Deseja continuar logado?</p>
    <button onclick="continuarSessao()">Continuar Logado</button>
    <button onclick="sairSessao()">Sair</button>
  </div>
</div>

<script>
  // Monitoramento de sess√£o (c√≥digo inalterado)
  let tempoExpiracao = 30 * 60 * 1000;
  let avisoExpiracao = 28 * 60 * 1000;
  let modal = document.getElementById("session-modal");
  let sessionTimeout;
  function iniciarMonitoramentoSessao() {
    setTimeout(() => { modal.style.display = "flex"; }, avisoExpiracao);
    sessionTimeout = setTimeout(() => { window.location.href = "/auth/logout"; }, tempoExpiracao);
  }
  function continuarSessao() {
    modal.style.display = "none";
    clearTimeout(sessionTimeout);
    fetch("/auth/renovar-sessao", { method: "GET" })
      .then(response => console.log("Sess√£o renovada"))
      .catch(error => console.error("Erro ao renovar sess√£o", error));
    iniciarMonitoramentoSessao();
  }
  function sairSessao() { window.location.href = "/auth/logout"; }
  document.addEventListener("DOMContentLoaded", iniciarMonitoramentoSessao);

  // Fun√ß√µes para adicionar novos blocos de inputs dinamicamente
  function adicionarPessoa() {
    const novaPessoa = document.createElement("div");
    novaPessoa.className = "bloco";
    novaPessoa.innerHTML = `
      <label>Nome da Pessoa:</label>
      <input type="text" class="pessoa-nome" placeholder="Nome da pessoa" required>
      <label>CPF:</label>
      <input type="text" class="pessoa-cpf" placeholder="CPF da pessoa" required>
    `;
    document.getElementById("pessoas-container").appendChild(novaPessoa);
  }

  function adicionarVeiculo() {
    const novoVeiculo = document.createElement("div");
    novoVeiculo.className = "bloco";
    novoVeiculo.innerHTML = `
      <label>Modelo do Ve√≠culo:</label>
      <input type="text" class="veiculo-modelo" placeholder="Modelo do ve√≠culo" required>
      <label>Placa do Ve√≠culo:</label>
      <input type="text" class="veiculo-placa" placeholder="Placa do ve√≠culo" required>
    `;
    document.getElementById("veiculos-container").appendChild(novoVeiculo);
  }

  function adicionarEquipamento() {
    const novoEquipamento = document.createElement("div");
    novoEquipamento.className = "bloco";
    novoEquipamento.innerHTML = `
      <label>Descri√ß√£o do Equipamento:</label>
      <input type="text" class="equipamento-descricao" placeholder="Descri√ß√£o do equipamento" required>
      <label>N√∫mero de S√©rie:</label>
      <input type="text" class="equipamento-numero-serie" placeholder="N√∫mero de s√©rie" required>
      <label>Quantidade:</label>
      <input type="number" class="equipamento-quantidade" placeholder="Quantidade" min="1" required>
    `;
    document.getElementById("equipamentos-container").appendChild(novoEquipamento);
  }

  // Fun√ß√£o para enviar o pedido via fetch
  function enviarPedido() {
    const cnpj = document.getElementById("cnpj_empresa").value;
    if (!validarCNPJ(cnpj)) {
      document.getElementById("mensagem").innerText = "CNPJ inv√°lido!";
      document.getElementById("mensagem").style.color = "red";
      return;
    }

    // Coleta dos campos que s√£o strings simples (separadas por v√≠rgula, se necess√°rio)
    const embarcacoes = document.getElementById("embarcacoes").value
      .split(",").map(item => item.trim()).filter(item => item !== "");

    // Coleta dos dados de ve√≠culos
    const veiculos = [];
    document.querySelectorAll("#veiculos-container .bloco").forEach(el => {
      const modelo = el.querySelector('.veiculo-modelo').value.trim();
      const placa = el.querySelector('.veiculo-placa').value.trim();
      if (modelo && placa) {
        veiculos.push({ modelo: modelo, placa: placa });
      }
    });

    // Coleta dos dados de equipamentos
    const equipamentos = [];
    document.querySelectorAll("#equipamentos-container .bloco").forEach(el => {
      const descricao = el.querySelector('.equipamento-descricao').value.trim();
      const numeroSerie = el.querySelector('.equipamento-numero-serie').value.trim();
      const quantidade = el.querySelector('.equipamento-quantidade').value.trim();
      if (descricao && numeroSerie && quantidade) {
        equipamentos.push({
          descricao: descricao,
          numero_serie: numeroSerie,
          quantidade: parseInt(quantidade)
        });
      }
    });

    // Coleta dos dados de pessoas
    const pessoas = [];
    document.querySelectorAll("#pessoas-container .bloco").forEach(el => {
      const nome = el.querySelector('.pessoa-nome').value.trim();
      const cpf = el.querySelector('.pessoa-cpf').value.trim();
      if (nome && cpf) {
        pessoas.push({ nome: nome, cpf: cpf });
      }
    });

    // Monta o objeto pedido
    const pedido = {
      nome_empresa: document.getElementById("nome_empresa").value,
      cnpj_empresa: cnpj,
      endereco_empresa: document.getElementById("endereco_empresa").value,
      motivo_solicitacao: document.getElementById("motivo_solicitacao").value,
      data_inicio: document.getElementById("data_inicio").value,
      data_termino: document.getElementById("data_termino").value,
      horario_inicio_servicos: document.getElementById("horario_inicio_servicos").value,
      horario_termino_servicos: document.getElementById("horario_termino_servicos").value,
      num_certificado_livre_pratica: document.getElementById("num_certificado_livre_pratica").value,
      embarcacoes: embarcacoes,
      veiculos: veiculos,
      equipamentos: equipamentos,
      pessoas: pessoas
    };

    fetch('/api/pedidos-autorizacao', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(pedido)
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(errorData => {
          throw new Error(errorData.error || 'Erro ao criar pedido.');
        });
      }
      return response.json();
    })
    .then(data => {
      document.getElementById("mensagem").innerText = `Pedido criado com sucesso! ID: ${data.id_autorizacao}`;
      document.getElementById("mensagem").style.color = "green";
    })
    .catch(error => {
      document.getElementById("mensagem").innerText = error.message;
      document.getElementById("mensagem").style.color = "red";
      console.error("Erro:", error);
    });
  }

  // Fun√ß√£o de valida√ß√£o de CNPJ (inalterada)
  function validarCNPJ(cnpj) {
    cnpj = cnpj.replace(/[^\d]+/g, "");
    if (cnpj.length !== 14) return false;
    if (/^(\d)\1+$/.test(cnpj)) return false;
    let tamanho = cnpj.length - 2;
    let numeros = cnpj.substring(0, tamanho);
    let digitos = cnpj.substring(tamanho);
    let soma = 0;
    let pos = tamanho - 7;
    for (let i = tamanho; i >= 1; i--) {
      soma += numeros.charAt(tamanho - i) * pos--;
      if (pos < 2) pos = 9;
    }
    let resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
    if (resultado !== parseInt(digitos.charAt(0))) return false;
    tamanho += 1;
    numeros = cnpj.substring(0, tamanho);
    soma = 0;
    pos = tamanho - 7;
    for (let i = tamanho; i >= 1; i--) {
      soma += numeros.charAt(tamanho - i) * pos--;
      if (pos < 2) pos = 9;
    }
    resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
    if (resultado !== parseInt(digitos.charAt(1))) return false;
    return true;
  }
</script>

</body>
</html>